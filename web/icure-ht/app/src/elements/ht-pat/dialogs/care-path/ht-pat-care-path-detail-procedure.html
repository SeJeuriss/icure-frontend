<link rel="import" href="../../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../../bower_components/vaadin-icons/vaadin-icons.html">
<link rel="import" href="../../../../../bower_components/vaadin-material-theme/vaadin-date-picker.html">
<link rel="import" href="../../../../../bower_components/vaadin-material-theme/vaadin-text-field.html">
<link rel="import" href="../../../../../bower_components/vaadin-material-theme/vaadin-checkbox.html">
<link rel="import" href="../../../../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../../../../../bower_components/vaadin-form-layout/vaadin-form-layout.html">
<link rel="import" href="../../../../../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../../../../../bower_components/vaadin-text-field/vaadin-text-area.html">
<link rel="import" href="../../../../../bower_components/vaadin-checkbox/vaadin-checkbox.html">
<link rel="import" href="../../../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../../../bower_components/paper-styles/shadow.html">
<link rel="import" href="../../../../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../../../dynamic-form/dynamic-link.html">
<link rel="import" href="../../../dynamic-form/dynamic-pills.html">
<link rel="import" href="../../../ht-spinner/ht-spinner.html">
<link rel="import" href="../../../dynamic-form/dynamic-doc.html">
<link rel="import" href="../../../collapse-button/collapse-button.html">
<link rel="import" href="../../../../styles/dialog-style.html">
<link rel="import" href="../../../../styles/scrollbar-style.html">
<link rel="import" href="../../../../styles/buttons-style.html">
<link rel="import" href="../../../../styles/notification-style.html">
<link rel="import" href="../../../../styles/spinner-style.html">
<link rel="import" href="../../../../styles/shared-styles.html">
<link rel="import" href="../../../../styles/paper-tabs-style.html">

<dom-module id="ht-pat-care-path-detail-procedure">
    <template>
        <style include="dialog-style scrollbar-style buttons-style notification-style spinner-style shared-styles paper-tabs-style">

            .btn-dropdown-container paper-button{
                display: flex;
                flex-flow: row nowrap;
                justify-content: flex-start;
                align-items: center;
                text-transform: capitalize;
                height: 28px;
                padding: 0 12px 0 8px;
                font-weight: 400;
                font-size: var(--font-size-normal);
                text-align: left;
                white-space: nowrap;
                text-overflow: ellipsis;
                overflow: hidden;
                flex-grow: 1;
                border-radius: 0;
                margin: 0;
            }

            .btn-dropdown-container paper-icon-button:hover{
                background: var(--app-background-color-dark);
            }

            .btn-dropdown-container paper-button iron-icon{
                color: var(--app-secondary-color);
                height: 20px;
                width: 20px;
                margin-right: 4px;
                box-sizing: border-box;
            }

            .w50{
                width: 50%;
                padding: 4px;
            }

            .w100{
                width: 98%;
                padding: 4px;
            }

            .ko{
                color: var(--app-status-color-nok)
            }

            .ok{
                color: var(--app-status-color-ok)
            }

            .p4{
                padding: 4px;
            }


            .menu-item {
                @apply --padding-menu-item;
                height: 24px;
                min-height: 24px;
                font-size: var(--font-size-normal);
                text-transform: inherit;
                justify-content: space-between;
                cursor: pointer;
                @apply --transition;
            }

            .sublist .menu-item {
                font-size: var(--font-size-normal);
                min-height:20px;
                height:20px;
            }

            .menu-item:hover{
                background: var(--app-dark-color-faded);
                @apply --transition;
            }

            .menu-item .iron-selected{
                background:var(--app-primary-color);

            }

            .one-line-menu {
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                font-weight: 400;
                padding-left:0;
            }

            collapse-button[opened] .menu-item-icon{
                transform: scaleY(-1);
            }

            .sublist-procedure{
                background:var(--app-light-color);
                margin:0 0 0 0px;
                padding:0;
            }

            .table-line-menu {
                display: flex;
                flex-flow: row nowrap;
                justify-content: space-between;
                align-items: center;
                height: 100%;
                width: 100%;
            }

            .table-line-menu-top{
                padding-left: var(--padding-menu-item_-_padding-left);
                padding-right: var(--padding-menu-item_-_padding-right);
                box-sizing: border-box;
            }

            .table-line-menu div:not(:last-child){
                border-right: 1px solid var(--app-background-color-dark);
                height: 20px;
                line-height: 20px;
            }

            .one-line-menu {
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                font-weight: 400;
                padding-left:0;
            }

            .menu-item paper-icon-button.menu-item-icon--add, .list-info paper-icon-button.menu-item-icon {
                padding: 0px;
                height: 18px;
                width: 18px;
                border-radius: 3px;
                background: var(--app-secondary-color);
                color: var(--app-text-color-light);
                margin-right: 8px;
            }

            .w10{
                width: 9%;
            }
            .w20{
                width: 19%;
            }
            .w30{
                width: 29%;
            }
            .w40{
                width: 39%;
            }
            .w50{
                width: 49%;
            }
            .w60{
                width: 59%;
            }
            .w70{
                width: 69%;
            }
            .w80{
                width: 79%;
            }
            .w90{
                width: 89%;
            }
            .w100{
                width: 99%;
            }
            .m4{
                margin: 4px;
            }
            .p4{
                padding: 4px;
            }
            .mw30{
                min-width: 29%;
            }

            .procDetailDialog{
                display: flex;
                height: 100%;
                width: auto;
                margin: 0;
                padding: 0;
            }

            .proc-menu-list{
                height: 100%;
                width: 30%;
                background-color: var(--app-background-color-dark);
                border-right: 1px solid var(--app-background-color-dark);
                overflow: auto;
                position: relative;
            }

            .proc-menu-view{
                height: 100%;
                width: 70%;
                position: relative;
                background: white;
            }

            .table-line-menu .date{
                width: 14%;
                padding-right: 4px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            .table-line-menu .np-date{
                width: 20%;
                padding-right: 4px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }


            .table-line-menu .name{
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                padding-left: 4px;
                padding-right: 4px;
                width: 64%
            }

            .table-line-menu .np-type{
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                padding-left: 4px;
                padding-right: 4px;
                width: 80%
            }

            .table-line-menu .status{
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                padding-left: 4px;
                padding-right: 4px;
                width: 20%
            }

            .table-line-menu .dateTit{
                width: 14%;
                padding-right: 10px;
            }

            .table-line-menu .np-dateTit{
                width: 20%;
                padding-right: 10px;
            }


            .table-line-menu .nameTit{
                padding-left:4px;
                padding-right:4px;
                width: 64%;
            }

            .table-line-menu .np-typeTit{
                padding-left:4px;
                padding-right:4px;
                width: 80%;
            }

            .table-line-menu .statusTit{
                padding-left:4px;
                padding-right:4px;
                width: 20%;
            }

            iron-pages{
                height: calc(100% - 50px);
            }

            .proc-btn{
                justify-content: center;
                height: 40px;
                width: auto;
                display: flex;
                align-items: center;
            }

            .proc-submenu-container{
                height: calc(100% - 50px);
            }

            .new-proc-view{
                height: 100%;
                width: auto;
                display: flex;
            }

            .new-proc-view-list-container{
                width: 100%;
                height: 100%;
                overflow: auto;
            }

            .addBtn{
                height: 15px!important;
                padding: 1px!important;
                width: 10px!important;
            }

        </style>

        <div class="procDetailDialog">
            <div class="proc-menu-list">
                <div class="proc-submenu-container">
                    <ht-spinner active="[[isLoading]]"></ht-spinner>
                    <div class="proc-container">
                        <div class="proc-container-title">
                            [[localize('care-path-linked-proc', 'Linked procedures', language)]]
                        </div>
                        <div class="proc-container-list">
                            <paper-listbox id="" class="menu-content sublist-procedure" selectable="paper-item"  toggle-shift>
                                <div class="table-line-menu table-line-menu-top">
                                    <div class="dateTit">[[localize('dat','Date',language)]]</div>
                                    <div class="nameTit">[[localize('name','Name',language)]]</div>
                                    <div class="statusTit">[[localize('sta','Status',language)]]</div>
                                </div>
                                <template is="dom-repeat" items="[[selectedCarePath.linkedProcedures]]" as="proc" id="linkedProcList">
                                    <collapse-button>
                                        <paper-item slot="sublist-collapse-item" id$="[[proc.id]]" data-item$="[[proc]]" aria-selected="[[selected]]" class$="menu-trigger menu-item [[isIronSelected(selected)]]" on-tap="_showProcedure">
                                            <div id="subMenu-linked-proc" class="table-line-menu">
                                                <div class="date">[[_formatDate(proc.valueDate)]]</div>
                                                <div class="name">[[_getProcDescription(proc)]]</div>
                                                <div class="status">[[_getStatus(proc)]]</div>
                                            </div>
                                        </paper-item>
                                    </collapse-button>
                                </template>
                            </paper-listbox>
                        </div>
                    </div>
                </div>
                <div class="proc-btn">
                    <paper-button on-tap="_showNewProcDialog" class="button button--save"><iron-icon icon="vaadin:plus-circle-o"></iron-icon>[[localize('care-path-add-procedure', 'Add procedure', language)]]</paper-button>
                </div>
                <ht-spinner active="[[isLoading]]"></ht-spinner>
            </div>
            <div class="proc-menu-view">
                <template is="dom-if" if="[[_isSelectedProcedure(selectedProcedure, selectedProcedure.*)]]">
                    <div class="proc-preview">

                    </div>
                </template>
                <template is="dom-if" if="[[newProcedureView]]">
                    <div class="new-proc-view">
                       <div class="new-proc-view-list-container">
                           <template is="dom-repeat" items="[[availablePackageOfProcedure]]" as="pack" >
                               <collapse-button id="[[pack.id]]">
                                   <paper-item id="account" slot="sublist-collapse-item" class="menu-trigger menu-item bold" on-tap="toggleMenu" elevation="">
                                       <div class="one-line-menu list-title account-line">
                                           <div>
                                               <span class="force-left force-ellipsis box-txt bold">[[_getPackageTitle(pack)]]</span>
                                           </div>
                                       </div>
                                       <paper-icon-button class="menu-item-icon" icon="hardware:keyboard-arrow-down" hover="none" on-tap="toggleMenu"></paper-icon-button>
                                   </paper-item>
                                   <paper-listbox id="" class="menu-content sublist" selectable="paper-item"  toggle-shift>
                                       <div class="table-line-menu table-line-menu-top">
                                           <div class="np-typeTit">[[localize('type','Type',language)]]</div>
                                           <div class="np-dateTit">[[localize('care-path-proc-est-date','Est. date',language)]]</div>
                                       </div>
                                       <template is="dom-repeat" items="[[pack.linkedProcedure]]">
                                           <collapse-button>
                                               <paper-item slot="sublist-collapse-item" id="[[pack.id]]" data-item$="[[item]]" aria-selected="[[selected]]" class$="menu-trigger menu-item [[isIronSelected(selected)]]" on-tap="_addProcedure">
                                                   <div id="subMenu" class="table-line-menu">
                                                       <div class="np-type">
                                                           <paper-icon-button class="button--icon-btn addBtn" icon="vaadin:plus" id="[[pack.id]]" data-item$="[[item]]" on-tap="_addProcedure"></paper-icon-button>
                                                           [[_getDescription(item)]]
                                                       </div>
                                                       <div class="np-date">[[_getEstimateDate(item, pack)]]</div>
                                                   </div>
                                               </paper-item>
                                           </collapse-button>
                                       </template>
                                   </paper-listbox>
                               </collapse-button>
                           </template>
                       </div>
                    </div>
                </template>
            </div>
        </div>

    </template>
    <script>
        import * as models from 'icc-api/dist/icc-api/model/models';
        import moment from 'moment/src/moment';
        import juicy from 'juicy-html'
        import mustache from "mustache/mustache.js";
        import Chart from 'chart.js';

        class HtPatCarePathDetailProcedure extends Polymer.TkLocalizerMixin(Polymer.mixinBehaviors([Polymer.IronResizableBehavior], Polymer.Element)) {

            static get is() {
                return 'ht-pat-care-path-detail-procedure';
            }

            static get properties() {
                return {
                    api: {
                        type: Object,
                        value: null
                    },
                    user: {
                        type: Object,
                        value: null
                    },
                    language: {
                        type: String
                    },
                    currentContact:{
                        type: Object,
                        value: () => {}
                    },
                    hcp:{
                        type: Object,
                        value: () => {}
                    },
                    patient:{
                        type: Object,
                        value: () => {}
                    },
                    selectedCarePath:{
                        type: Object,
                        value: () => {}
                    },
                    isLoading:{
                        type: Boolean,
                        value: false
                    },
                    newProcedureView:{
                        type: Boolean,
                        value: false
                    },
                    selectedCarePathType:{
                        type: Object,
                        value: {}
                    },
                    availablePackageOfProcedure:{
                        type: Array,
                        value: []
                    },
                    periodicityConverter:{
                        type: Array,
                        value : [
                            {code: "D", numberToAdd: 1, periodToAdd: "days"},
                            {code: "DA", numberToAdd: 8, periodToAdd: "days"},
                            {code: "DD", numberToAdd: 3, periodToAdd: "days"},
                            {code: "DE", numberToAdd: 11, periodToAdd: "days"},
                            {code: "DN", numberToAdd: 9, periodToAdd: "days"},
                            {code: "DQ", numberToAdd: 5, periodToAdd: "days"},
                            {code: "DT", numberToAdd: 2, periodToAdd: "days"},
                            {code: "DV", numberToAdd: 4, periodToAdd: "days"},
                            {code: "DW", numberToAdd: 12, periodToAdd: "days"},
                            {code: "DX", numberToAdd: 10, periodToAdd: "days"},
                            {code: "DZ", numberToAdd: 6, periodToAdd: "days"},
                            {code: "J", numberToAdd: 1, periodToAdd: "year"},
                            {code: "JD", numberToAdd: 3, periodToAdd: "years"},
                            {code: "JH2", numberToAdd: 6, periodToAdd: "months"},
                            {code: "JQ", numberToAdd: 5, periodToAdd: "years"},
                            {code: "JT", numberToAdd: 2, periodToAdd: "years"},
                            {code: "JV", numberToAdd: 4, periodToAdd: "years"},
                            {code: "JZ", numberToAdd: 6, periodToAdd: "years"},
                            {code: "M", numberToAdd: 1, periodToAdd: "months"},
                            {code: "MA", numberToAdd: 8, periodToAdd: "months"},
                            {code: "MC", numberToAdd: 18, periodToAdd: "months"},
                            {code: "MD", numberToAdd: 3, periodToAdd: "months"},
                            {code: "ME", numberToAdd: 11, periodToAdd: "months"},
                            {code: "MN", numberToAdd: 9, periodToAdd: "months"},
                            {code: "MQ", numberToAdd: 5, periodToAdd: "months"},
                            {code: "MS", numberToAdd: 7, periodToAdd: "months"},
                            {code: "MT", numberToAdd: 2, periodToAdd: "months"},
                            {code: "MV", numberToAdd: 4, periodToAdd: "months"},
                            {code: "MX", numberToAdd: 10, periodToAdd: "months"},
                            {code: "MZ2", numberToAdd: 6, periodToAdd: "months"},
                            {code: "W", numberToAdd: 7, periodToAdd: "days"},
                            {code: "WA", numberToAdd: 8, periodToAdd: "weeks"},
                            {code: "WD", numberToAdd: 3, periodToAdd: "weeks"},
                            {code: "WE", numberToAdd: 11, periodToAdd: "weeks"},
                            {code: "WN", numberToAdd: 9, periodToAdd: "weeks"},
                            {code: "WP", numberToAdd: 24, periodToAdd: "weeks"},
                            {code: "WQ", numberToAdd: 5, periodToAdd: "weeks"},
                            {code: "WS", numberToAdd: 7, periodToAdd: "weeks"},
                            {code: "WT", numberToAdd: 2, periodToAdd: "weeks"},
                            {code: "WV", numberToAdd: 4, periodToAdd: "weeks"},
                            {code: "WW", numberToAdd: 12, periodToAdd: "weeks"},
                            {code: "WX", numberToAdd: 10, periodToAdd: "weeks"},
                            {code: "WZ", numberToAdd: 6, periodToAdd: "weeks"}
                        ]
                    },
                    selectedProcedure:{
                        type: Object,
                        value: () => {}
                    },
                    contacts: {
                        type: Object,
                        values: () => []
                    }
                };
            }

            static get observers() {
                return [];
            }

            ready() {
                super.ready();
            }

            _showNewProcDialog(){
                this.set('newProcedureView', true)
            }

            _getListOfProcedures(type){
                return _.get(_.get(this, 'availablePackageOfProcedure', []).find(pack => pack.code === type), 'linkedProcedure', [])
            }

            _getDescription(proc){
                return _.get(proc, "code", null)+" - "+_.get(proc, "label."+this.language, null)
            }

            _getProcDescription(proc){
                return _.get(_.get(proc, "codes", []).find(c => c.type === "BE-THESAURUS-PROCEDURES"), 'code', null)+" - "+_.get(proc, "content."+this.language+".stringValue", null)
            }

            _getPackageTitle(pack){
                return _.get(pack, "label."+this.language, null)
            }

            _getEstimateDate(item, pack){
                const period = this.periodicityConverter.find(period => period.code === _.get(_.get(item, "periodicity", []).find(p => _.get(p, "relatedCode.id", null) === pack.id), "relatedPeriodicity.code", null))
                return _.get(period, "numberToAdd", null) && _.get(period, "periodToAdd", null) ? moment(moment().add(_.get(period, "numberToAdd", null), _.get(period, "periodToAdd", null))).format("DD/MM/YYYY") : null
            }

            _formatDate(date){
                return date ? moment(date, "YYYYMMDDhhmmss").format("DD/MM/YYYY") : null
            }

            _getStatus(proc){
                return this.localize("cd-lifecycle-"+_.get(_.get(proc, 'tags', []).find(t => t.type === "CD-LIFECYCLE"), 'code', null), _.get(_.get(proc, 'tags', []).find(t => t.type === "CD-LIFECYCLE"), 'code', null), this.language)
            }

            _addProcedure(e){
                e.stopPropagation()
                if(_.get(e, 'currentTarget.dataset.item', null)){
                    const proc = JSON.parse(_.get(e, 'currentTarget.dataset.item', null))
                    const period = this.periodicityConverter.find(period => period.code === _.get(_.get(proc, "periodicity", []).find(p => _.get(p, "relatedCode.id", null) === e.currentTarget.id), "relatedPeriodicity.code", null))


                    let sbc = _.get(this.currentContact,"subContacts",[]).find(sbc => sbc.planOfActionId === _.get(this.selectedCarePath, 'id', null) && sbc.healthElementId === _.get(this.selectedCarePath, 'linkedHealthElement.id', null))

                    if (_.isEmpty(sbc)) {
                        this.push('currentContact.subContacts', {planOfActionId : _.get(this.selectedCarePath, 'id', null), healthElementId: _.get(this.selectedCarePath, 'linkedHealthElement.id', null), services: [] })
                        sbc = _.get(this.currentContact,"subContacts",[]).find(sbc => sbc.planOfActionId === _.get(this.selectedCarePath, 'id', null))
                    }

                    const svc = this.api.contact().service().newInstance(this.user, {
                        label: "Actes",
                        content: _.fromPairs([[this.language,{stringValue:_.trim(_.get(proc, 'label.'+this.language, null))}]]),
                        valueDate: _.get(period, "numberToAdd", null) && _.get(period, "periodToAdd", null) ? parseInt(moment(moment().add(_.get(period, "numberToAdd", null), _.get(period, "periodToAdd", null))).format("YYYYMMDD")+'000000') : null,
                        codes: [
                            {
                                id: _.trim(_.get(proc, 'id', null)),
                                type: _.trim(_.get(proc, 'type', null)),
                                code:  _.trim(_.get(proc, 'code', null)),
                                version:  _.trim(_.get(proc, 'version', null))
                            }
                        ],
                        tags: [
                            { type: 'CD-LIFECYCLE', code:'planned'}
                        ]
                    })

                    this.push("currentContact.services", svc)
                    sbc.services.push({ serviceId: svc.id })
                    sbc.services = sbc.services.map(s => _.omit(s, ['service']))
                    this.api.contact().modifyContactWithUser(this.user, this.currentContact)
                    .then(ctc => this.api.register(ctc, 'currentContact'))
                    .then(ctc => this.set("currentContact", ctc))
                    .then(() => this.api.contact().findBy(this.user.healthcarePartyId,this.patient))
                    .then(ctcs => {
                        console.log(ctcs)
                        this.set("contacts", ctcs)
                        const serviceIds = _.flatten(ctcs.filter(ctc => _.get(ctc, 'subContacts', []).find(sctc => _.get(sctc, 'planOfActionId', "") === _.get(this.selectedCarePath, 'id', null))).map(ctc => _.get(_.get(ctc, 'subContacts', []).find(sctc => _.get(sctc, 'planOfActionId', "") === _.get(this.selectedCarePath, 'id', null)), 'services', []))).map(svc => svc.serviceId)
                        this.set('selectedCarePath.linkedProcedures', _.flatten(ctcs.map(ctc => _.get(ctc, 'services', []))).filter(svc => serviceIds.find(s => s === svc.id)))
                     })
                    .finally(() => {
                        this.shadowRoot.querySelector('#linkedProcList') && this.shadowRoot.querySelector('#linkedProcList').render()
                    })

                }
            }
        }
        customElements.define(HtPatCarePathDetailProcedure.is, HtPatCarePathDetailProcedure);
    </script>
</dom-module>
