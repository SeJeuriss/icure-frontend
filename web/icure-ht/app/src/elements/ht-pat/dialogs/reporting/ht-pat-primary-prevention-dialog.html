<link rel="import" href="../../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../../bower_components/vaadin-icons/vaadin-icons.html">
<link rel="import" href="../../../../../bower_components/vaadin-material-theme/vaadin-date-picker.html">
<link rel="import" href="../../../../../bower_components/vaadin-material-theme/vaadin-text-field.html">
<link rel="import" href="../../../../../bower_components/vaadin-material-theme/vaadin-checkbox.html">
<link rel="import" href="../../../../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../../../../../bower_components/vaadin-form-layout/vaadin-form-layout.html">
<link rel="import" href="../../../../../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../../../../../bower_components/vaadin-text-field/vaadin-text-area.html">
<link rel="import" href="../../../../../bower_components/vaadin-checkbox/vaadin-checkbox.html">
<link rel="import" href="../../../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../../../bower_components/paper-styles/shadow.html">
<link rel="import" href="../../../../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../../../dynamic-form/dynamic-link.html">
<link rel="import" href="../../../dynamic-form/dynamic-pills.html">
<link rel="import" href="../../../ht-spinner/ht-spinner.html">
<link rel="import" href="../../../dynamic-form/dynamic-doc.html">
<link rel="import" href="../../../collapse-button/collapse-button.html">
<link rel="import" href="../../../../styles/dialog-style.html">
<link rel="import" href="../../../../styles/scrollbar-style.html">
<link rel="import" href="../../../../styles/paper-tabs-style.html">

<dom-module id="ht-pat-primary-prevention-dialog">
    <template>
        <style include="dialog-style scrollbar-style paper-tabs-style">

            #preventionDialog{
                height: calc(98% - 12vh);
                width: 98%;
                max-height: calc(100% - 64px - 48px - 20px); /* 100% - header - margin - footer*/
                min-height: 400px;
                min-width: 800px;
                top: 64px;
            }

            .preventionDialog{
                height: calc(100% - 45px);;
                width: auto;
                margin: 0;
                padding: 0;
            }

            .prevention-dialog-content{
                height: 100%;
                width: 100%;
                position: relative;
                background: white;
                display: flex;
            }

            .prevention-dialog-title{
                height: 48px;
                width: 100%;
                border-bottom: 1px solid var(--app-background-color-darker);
                background-color: var(--app-background-color-dark);
                padding: 0 12px;
                display: flex;
                flex-flow: row wrap;
                justify-content: flex-start;
                align-items: center;
                box-sizing: border-box;
            }

            .prevention-history-content{
                height: calc(100% - 50px);
                width: 30%;
                position: relative;
                background: white;
            }

            .prevention-procedure-content{
                height: calc(100% - 50px);
                width: 100%;
                position: relative;
                background: white;
            }

            .prevention-line{
                width: auto;
                display: flex;
            }

            .w10{
                width: 9%;
            }

            .w20{
                width: 19%;
            }

            .w30{
                width: 29%;
            }

            .w40{
                width: 39%;
            }

            .w50{
                width: 49%;
            }

            .w60{
                width: 59%;
            }

            .w70{
                width: 69%;
            }

            .w80{
                width: 79%;
            }

            .w90{
                width: 89%;
            }

            .w100{
                width: 99%;
            }

            .m4{
                margin: 4px;
            }

            .p4{
                padding: 4px;
            }

            .mw30{
                min-width: 29%;
            }

            .prevention-error{
                color: var(--app-status-color-nok)
            }


        </style>

        <paper-dialog id="preventionDialog">
            <div class="preventionDialog">
                <div class="prevention-dialog-content">
                    <div class="prevention-procedure-content">
                        <paper-tabs selected="{{tabs}}" >
                            <paper-tab>
                                <iron-icon class="tabIcon" icon="vaadin:group"></iron-icon> [[localize('prev-crea-prev-act', 'Create prevention acts', language)]]
                            </paper-tab>
                        </paper-tabs>
                        <page>
                            <div class="m4">
                                <div class="prevention-line">
                                    <vaadin-combo-box class="w100 p4" filtered-items="[[listOfClinicalPlan]]" item-label-path="label.[[language]]" item-value-path="id" id="prevention-list" label="Type de prévention*" value="{{prevention.clinicalPlanId}}"></vaadin-combo-box>
                                </div>
                                <div class="prevention-line">
                                    <vaadin-combo-box class="w70 p4" filtered-items="[[filteredProcedures]]" item-label-path="label.[[language]]" item-value-path="id" id="procedures-list" filter="{{procedureFilter}}" label="Procédure*" value="{{prevention.procedureId}}"></vaadin-combo-box>
                                    <vaadin-date-picker class="mw30 p4" id="date-picker" label="Date d'échéance*" value="{{prevention.deadline}}" i18n="[[i18n]]" on-value-changed="_checkIsDeadline"></vaadin-date-picker>
                                </div>
                                <div class="prevention-line">
                                    <vaadin-text-area class="w100 p4" class="textarea-style" id="cpa_description" label="Description" value="{{prevention.description}}"></vaadin-text-area>
                                </div>
                                <div class="prevention-line">
                                    <vaadin-combo-box class="w100 p4" filtered-items="[[remindType]]" item-label-path="label.[[language]]" item-value-path="code" id="remindType-list" label="Type de rappel" value="{{prevention.remindType}}"></vaadin-combo-box>
                                </div>
                            </div>
                            <div class="prevention-error m4">
                                <template is="dom-repeat" items="[[errorList]]">
                                    <div>
                                        [[localize(item.code, item.label, language)]]
                                    </div>
                                </template>
                            </div>
                        </page>
                    </div>
                </div>
                <div class="buttons">
                    <paper-button class="button" on-tap="_closeDialog"><iron-icon icon="icons:close" class="mr5 smallIcon" ></iron-icon> [[localize('clo','Close',language)]]</paper-button>
                    <paper-button class="button button--save" on-tap="_sendPrevention"><iron-icon icon="icons:send" class="mr5 smallIcon" ></iron-icon> [[localize('send','Send',language)]]</paper-button>
                </div>
            </div>
        </paper-dialog>

    </template>
    <script>
        import moment from 'moment/src/moment';

        class HtPatPrimaryPreventionDialog extends Polymer.TkLocalizerMixin(Polymer.mixinBehaviors([Polymer.IronResizableBehavior], Polymer.Element)) {
            static get is() {
                return 'ht-pat-primary-prevention-dialog';
            }

            static get properties() {
                return {
                    api: {
                        type: Object,
                        value: null
                    },
                    user: {
                        type: Object,
                        value: null
                    },
                    language: {
                        type: String
                    },
                    selectedPatientForPrevention:{
                        type: Array,
                        value: () => []
                    },
                    proceduresListItem:{
                        type: Array,
                        value: []
                    },
                    tabs:{
                        type: Number,
                        value: 0
                    },
                    listOfProcedures:{
                        type: Array,
                        value: []
                    },
                    procedureFilter:{
                        type: String,
                        value: null
                    },
                    filteredProcedures:{
                        type: Array,
                        value: () => []
                    },
                    prevention: {
                        type: Object,
                        value: () => {}
                    },
                    remindType:{
                        type: Array,
                        value: () => [
                            {label: {fr:'Par sms', nl:'Bij sms', en:'By sms'}, code: "sms"},
                            {label: {fr:'Par email', nl:'Bij mail', en:'By email'}, code:"mail"}
                        ]
                    },
                    listOfClinicalPlan:{
                        type: Array,
                        value: () => []
                    },
                    errorList:{
                        type: Array,
                        value: () => []
                    }

                };
            }

            static get observers() {
                return ['_procedureFilterChanged(procedureFilter)'];
            }

            ready() {
                super.ready();
            }

            openPreventionDialog(){
                this.api.code().findCodes("be", "BE-THESAURUS-PROCEDURES").then(listOfProc => {
                    this.set('listOfProcedures',listOfProc.map(p => _.assign(p, {
                        normalizedSearchTerms: _.map(_.uniq(_.compact(_.flatten(_.concat([_.get(p, _.trim('label.'+this.language), ""), _.get(p, 'code', ""), _.get(p, 'searchTerms.'+this.language, "")])))), i =>  _.trim(i).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, "")).join(" ")
                    })))
                }).then(() => this.api.code().findCodes("be", "CD-CLINICALPLAN"))
                    .then(listOfClinicalPlan => this.set('listOfClinicalPlan', listOfClinicalPlan))
                    .finally(() => {
                    this.set('prevention', {
                        title: null,
                        clinicalPlanId: null,
                        procedureId: null,
                        deadline: null,
                        linkedProfession: null,
                        description: null,
                        remindType: null,
                        label: 'Actes'
                    })
                    this.set('filterdProcedure', this.listOfProcedures)
                    this.$['preventionDialog'].open()
                })

            }

            _closeDialog(){
                this.set('prevention', {})
                this.set('errorList', [])
                this.$['preventionDialog'].close()
            }

            _procedureFilterChanged(){
                if(this.procedureFilter){
                    const keywordsString = _.trim(_.get(this,"procedureFilter","")).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, "")
                    const keywordsArray = _.compact(_.uniq(_.map(keywordsString.split(" "), i=>_.trim(i))))
                    setTimeout(() => {
                        if(parseInt(_.get(keywordsString,"length",0)) > 2) {
                            const proceduresSearchResults =  _.chain(_.get(this, "listOfProcedures", []))
                                .chain(_.get(this, "procedureFilter", []))
                                .filter(i => _.size(keywordsArray) === _.size(_.compact(_.map(keywordsArray, keyword => _.trim(_.get(i, "normalizedSearchTerms", "")).indexOf(keyword) > -1))))
                                .compact()
                                .uniq()
                                .orderBy(['code', 'label.' + this.language, 'id'], ['asc', 'asc', 'asc'])
                                .value()
                            this.set('filteredProcedures', _.sortBy(proceduresSearchResults, ['code', 'label.' + this.language, 'id'], ['asc', 'asc', 'asc']))
                        }else{
                            this.set('filteredProcedures', _.sortBy(this.listOfProcedures, ['code', 'label.'+this.language, 'id'], ['asc', 'asc', 'asc']))
                        }
                    }, 100)
                }
            }

            _sendPrevention(){
                console.log(this.prevention)
                this.set('errorList', [])
                let prom = Promise.resolve()

                if(_.get(this.prevention, 'clinicalPlanId', null) && _.get(this.prevention, 'deadline', null) && _.get(this.prevention, 'procedureId', null)){
                    this.selectedPatientForPrevention.map(pat => {
                        if(pat.check === true){
                            prom = prom.then(listOfContact => {
                                return this.api.patient().getPatientWithUser(this.user, pat.id).then(pat => Promise.all([pat, this.api.contact().newInstance(this.user, pat, {
                                    created: +new Date,
                                    modified: +new Date,
                                    author: _.trim(_.get(this,"user.id","")),
                                    responsible: _.trim(_.get(this,"user.healthcarePartyId","")),
                                    openingDate: +new Date,
                                    closingDate: +new Date,
                                    encounterType: { type: "CD-TRANSACTION", version: "1", code: 'request' },
                                    descr: _.get(this.prevention, 'description', null),
                                    tags: [
                                        { type: 'CD-TRANSACTION', code: 'request'},
                                        {
                                            id: _.get(this.listOfClinicalPlan.find(cp => cp.id === _.get(this.prevention, 'clinicalPlanId', null)), 'id' , null),
                                            type: _.get(this.listOfClinicalPlan.find(cp => cp.id === _.get(this.prevention, 'clinicalPlanId', null)), 'type' , null),
                                            code: _.get(this.listOfClinicalPlan.find(cp => cp.id === _.get(this.prevention, 'clinicalPlanId', null)), 'code' , null),
                                            version: _.get(this.listOfClinicalPlan.find(cp => cp.id === _.get(this.prevention, 'clinicalPlanId', null)), 'version' , null)
                                        }
                                    ],
                                    services: []
                                })])).then(([pat, ctc]) => Promise.all([pat, ctc, this.api.contact().service().newInstance(this.user, {
                                    content: _.fromPairs([[this.language, {
                                        stringValue: _.trim(_.get(this.prevention, 'description', null))}]]),
                                    label: _.get(this.prevention, "label", "Actes"),
                                    comment: _.trim(_.get(this.prevention, 'description', null)),
                                    valueDate: _.get(this.prevention, 'deadline', null) ? this.api.moment(_.get(this.prevention, 'deadline', null)).format('YYYYMMDD') : null,
                                    codes: [
                                        {
                                            id: _.get(this.listOfProcedures.find(proc => proc.id === this.prevention.procedureId), 'id', null),
                                            type: _.get(this.listOfProcedures.find(proc => proc.id === this.prevention.procedureId), 'type', null),
                                            code:  _.get(this.listOfProcedures.find(proc => proc.id === this.prevention.procedureId), 'code', null),
                                            version:  _.get(this.listOfProcedures.find(proc => proc.id === this.prevention.procedureId), 'version', null)
                                        }
                                    ],
                                    tags: [
                                        { type: 'CD-TRANSACTION', code: 'request'},
                                        {
                                            id: _.get(this.listOfClinicalPlan.find(cp => cp.id === _.get(this.prevention, 'clinicalPlanId', null)), 'id' , null),
                                            type: _.get(this.listOfClinicalPlan.find(cp => cp.id === _.get(this.prevention, 'clinicalPlanId', null)), 'type' , null),
                                            code: _.get(this.listOfClinicalPlan.find(cp => cp.id === _.get(this.prevention, 'clinicalPlanId', null)), 'code' , null),
                                            version: _.get(this.listOfClinicalPlan.find(cp => cp.id === _.get(this.prevention, 'clinicalPlanId', null)), 'version' , null)
                                        },
                                        { type: 'CD-LIFECYCLE', code:'planned'}
                                    ]
                                })])).then(([pat, ctc, svc]) => {
                                    ctc.services.push(svc)
                                    return Promise.all([pat, this.api.contact().createContactWithUser(this.user, ctc)])
                                }).then(([pat, ctc]) => _.concat(listOfContact, {contact: ctc, patient: pat}))
                            })
                        }
                    })

                    prom = prom.then(listOfContact => {
                        listOfContact.map(ctc => {
                            const mobilePhone = ctc.patient.addresses.map(a => (a.addressType === 'home' || a.addressType === 'work') && a.telecoms.map(t=>t.telecomType === 'mobile' && t.telecomNumber).filter(x=>x)[0]).filter(x=>x)[0]
                            _.get(this.prevention, 'remindType', null) === 'sms' ? (mobilePhone && fetch(`https://msg-gw.svcacc.icure.cloud/luta/sms/to/${mobilePhone}`,{
                                method: "POST",
                                headers: { "Content-Type" : "application/json", "Authorization": `Basic ${btoa('luta:@dv@nc3dPl@nn1ng')}` },
                                body: JSON.stringify({message: _.get(this.prevention, 'description', null)})
                            })) : null
                        })
                    }).finally(() => {
                        this._closeDialog()
                        this.dispatchEvent(new CustomEvent('close-prevention', {detail : null, bubbles: true, composed: true}))
                    })

                }else{
                    !_.get(this.prevention, 'clinicalPlanId', null) ? this.push('errorList', {code: 'prev-crea-err-clinPlan', label: "Clinical plan must be completed"}) : null
                    !_.get(this.prevention, 'deadline', null) ? this.push('errorList', {code: 'pre-crea-err-deadline', label: " Deadline must be completed"}) : null
                    !_.get(this.prevention, 'procedureId', null) ? this.push('errorList', {code: 'pre-crea-err-procedure', label: "Procedure must be completed"}) : null
                }
            }

        }
        customElements.define(HtPatPrimaryPreventionDialog.is, HtPatPrimaryPreventionDialog);
    </script>
</dom-module>
