<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../ht-spinner/ht-spinner.html">

<link rel="import" href="../../../../bower_components/vaadin-material-theme/vaadin-grid.html">
<link rel="import" href="../../../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../../../bower_components/vaadin-grid/vaadin-grid-column.html">
<link rel="import" href="../../../../bower_components/vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="../../../../bower_components/vaadin-icons/vaadin-icons.html">

<link rel="import" href="../../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/image-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/editor-icons.html">

<link rel="import" href="../../../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../../bower_components/paper-input/paper-input-container.html">
<link rel="import" href="../../../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../../../bower_components/paper-styles/shadow.html">

<link rel="import" href="../../dynamic-form/dynamically-loaded-form.html">

<link rel="import" href="../../dynamic-form/dynamic-doc.html">
<link rel="import" href="../../pdf-element/pdf-element.html">

<link rel="import" href="../../../shared-styles.html">
<link rel="import" href="../../../dialog-style.html">
<link rel="import" href="../../../notification-style.html">
<link rel="import" href="../../../spinner-style.html">
<link rel="import" href="../../../scrollbar-style.html">





<dom-module id="ht-pat-triptyque-dialog">





    <template>





        <style include="shared-styles dialog-style notification-style spinner-style scrollbar-style">

            .singlePdfPrescription {
                border:1px solid var(--app-primary-color);
                margin-bottom:20px;
                box-shadow: var(--shadow-elevation-2dp_-_box-shadow);

            }

            .singlePdfPrescription .header {
                background-color: var(--app-primary-color);
                color:#ffffff;

            }

            #pdfPrescriptionsList .singlePdfPrescription paper-button {
                min-width:0;
            }

        </style>





        <paper-dialog id="triptyqueDialog" always-on-top="true" no-cancel-on-outside-click="true" no-cancel-on-esc-key="true">



            <template is="dom-if" if="[[_isLoading]]">
                <div id="loadingContainer">
                    <div id="loadingContentContainer">
                        <div class="mw100 m0auto"><ht-spinner class="spinner" alt="Loading..." active></ht-spinner></div>
                        <div id="loadingContent"></div>
                    </div>
                </div>
            </template>



            <template is="dom-if" if="[[_dialogParameters.actions.listing]]">



                <div class="panelNavigator m0 p0" id="panelNavigator_1">

                    <h3 class="p0 mt0">[[localize('onGoingPlansOfActions','Ongoing plans of actions',language)]] <span class="fspoint8em fw400">([[_formatTranslateGender(patient.gender)]] [[_ucFirst(patient.lastName)]] [[_ucFirst(patient.firstName)]] - [[_formatDateOfBirth(patient.dateOfBirth)]] - [[_dobToAge(patient.dateOfBirth)]] - [[patient.profession]])</span></h3>

                    <vaadin-grid id="vaadinGridPlanOfAction" class="m0 p0 vaadinGridPlanOfAction" items="[[_vaadinGridPlanOfActionDataToShow]]" active-item="{{_vaadinGridPlanOfActionActiveItem}}" pageSize="[[_vaadinGridPlanOfActionMaxItemsPerPage]]" on-selected-items-changed="_vaadinGridPlanOfActionActiveItemChanged">

                        <vaadin-grid-column width="100px" flex-grow="0">
                            <template class="header"><vaadin-grid-sorter path="openingDate"><b>[[localize('dat','Date',language)]]</b></vaadin-grid-sorter></template>
                            <template>[[item.openingDate]]</template>
                        </vaadin-grid-column>

                        <vaadin-grid-column flex-grow="1">
                            <template class="header"><vaadin-grid-sorter path="heDescr">[[localize('healthcareelement','Healthcare Elements',language)]]</vaadin-grid-sorter></template>
                            <template>[[item.heDescr]]</template>
                        </vaadin-grid-column>

                        <vaadin-grid-column width="100px" flex-grow="0">
                            <template class="header"><vaadin-grid-sorter path="documentIds">[[localize('prescription','Prescription',language)]]</vaadin-grid-sorter></template>
                            <template>[[item.prescriptionExists]]</template>
                        </vaadin-grid-column>

                        <vaadin-grid-column flex-grow="1">
                            <template class="header"><vaadin-grid-sorter path="name">[[localize('lab','Label',language)]]</vaadin-grid-sorter></template>
                            <template>[[item.label]]</template>
                        </vaadin-grid-column>

                        <vaadin-grid-column flex-grow="1">
                            <template class="header"><vaadin-grid-sorter path="prescriber">[[localize('prescriber','Prescriber',language)]]</vaadin-grid-sorter></template>
                            <template>[[item.prescriber]]</template>
                        </vaadin-grid-column>

                        <vaadin-grid-column flex-grow="1">
                            <template class="header"><vaadin-grid-sorter path="responsibleHr">[[localize('persphysicianRole','Physician',language)]]</vaadin-grid-sorter></template>
                            <template>[[item.responsibleHr]]</template>
                        </vaadin-grid-column>

                        <vaadin-grid-column width="100px" flex-grow="0">
                            <template class="header"><vaadin-grid-sorter path="contactsCount">[[localize('qua','Quantity',language)]]</vaadin-grid-sorter></template>
                            <template>[[item.contactsCount]]/[[item.numberOfCares]]</template>
                        </vaadin-grid-column>

                        <vaadin-grid-column width="150px" flex-grow="0">
                            <template class="header"><vaadin-grid-sorter path="statusHr">[[localize('sta','Status',language)]]</vaadin-grid-sorter></template>
                            <template>[[item.statusHr]]</template>
                        </vaadin-grid-column>

                        <vaadin-grid-column width="50px" flex-grow="0">
                            <template class="header"></template>
                            <template><paper-button class="tool-btn pl15 pr15" on-tap="_browseAppointments" data-plan-of-action-id="[[item.id]]"><iron-icon data-name="diary" icon="date-range" class="ml5"></iron-icon> [[localize('diary','Diary',language)]]</paper-button></template>
                        </vaadin-grid-column>

                    </vaadin-grid>

                    <div class="vaadinGridBottomActions mt20">
                        <div class="grid-size-indicator hideOnMobile"> [[pageStart]] – [[pageEnd]] [[localize('sur','sur',language)]] [[_totalMessagesForCurrentFolderAndCurrentFilter]]</div>
                        <paper-icon-button id="previous-page-change" icon="chevron-left" class="vaadinGridPageToPageNavigation" on-tap="_gotoPreviousGridPage"></paper-icon-button>
                        <paper-icon-button id="next-page-change" icon="chevron-right" class="vaadinGridPageToPageNavigation" on-tap="_gotoNextGridPage"></paper-icon-button>
                        <div class="hideOnMobile"><paper-icon-button class="vaadinGridScrollToTop" icon="arrow-upward" on-tap="_scrollToTop"></paper-icon-button></div>
                    </div>

                    <div class="buttons">
                        <paper-button on-tap="_closeTriptyqueDialog" class="modal-button modal-button--cancel"><iron-icon icon="icons:close" class=""></iron-icon>[[localize('clo','Close',language)]]</paper-button>
                        <paper-button on-tap="_addPlanOfAction" class="modal-button modal-button--save"><iron-icon icon="icons:add-circle" class="mr0"></iron-icon>[[localize('createPlanOfAction','Create plan of action',language)]]</paper-button>
                    </div>

                </div>



            </template>



            <template is="dom-if" if="[[_dialogParameters.actions.detail]]">

                <h3 class="p0 mt0">[[localize('detailsPlanOfActions','Details plan of actions',language)]] <span class="fspoint8em fw400">([[_formatTranslateGender(patient.gender)]] [[_ucFirst(patient.lastName)]] [[_ucFirst(patient.firstName)]] - [[_formatDateOfBirth(patient.dateOfBirth)]] - [[_dobToAge(patient.dateOfBirth)]] - [[patient.profession]])</span></h3>

                <div class="panelNavigator m0 p0 hasTabViews" id="panelNavigator_2">
                    <div class="panelNavigatorAnchor"><paper-button on-tap="_closePlanOfAction"><iron-icon icon="hardware:keyboard-arrow-left"></iron-icon> [[localize('onGoingPlansOfActions','Ongoing plans of actions',language)]]</paper-button></div>
                    <div class="panelNavigatorContent p0 mt0">



                        <div id="pdfPanel" class="">
                            <div id="pdfPrescriptionsList">



                                <template is="dom-if" if="[[_selectedPrescriptionBoolean]]">
                                    <h4 class="textaligncenter uppercase"><iron-icon icon="vaadin:pills" class="mr8 darkBlue"></iron-icon> [[localize('linkedPrescriptionToYourTriptyque','This prescription is linked to your triptyque',language)]]:</h4>
                                    <div class="singlePdfPrescription" data-service-id$="[[_selectedPrescriptionObject.service.id]]" data-form-id$="[[_selectedPrescriptionObject.formId]]" data-document-id$="[[_selectedPrescriptionObject.document.id]]">
                                        <div class="header p10">
                                            <span class="date">[[_selectedPrescriptionObject.dateAndTimeHr]]</span>
                                            <paper-button class="p0 m0 fr" on-tap="_unlinkPdfPrescription" data-contact-id$="[[_selectedPrescriptionObject.contact.id]]" data-service-id$="[[_selectedPrescriptionObject.service.id]]" data-form-id$="[[_selectedPrescriptionObject.formId]]" data-document-id$="[[_selectedPrescriptionObject.document.id]]"><iron-icon icon="vaadin:unlink" id$="unlink-[[_selectedPrescriptionObject.service.id]]"></iron-icon></paper-button><paper-tooltip for$="unlink-[[_selectedPrescriptionObject.service.id]]">[[localize('unlinkPdf','Unlink PDF',language)]]</paper-tooltip>
                                        </div>
                                        <div class="body p5 fspoint9em"><iron-icon icon="image:picture-as-pdf" class="mr5 darkRed"></iron-icon> [[_selectedPrescriptionObject.serviceTitle]]</div>
                                        <template is="dom-if" if="[[_selectedPrescriptionBoolean]]">
                                            <dynamic-doc
                                                id="selected-pdf-preview-[[_selectedPrescriptionObject.document.id]]"
                                                api="[[api]]"
                                                i18n="[[i18n]]"
                                                user="[[user]]"
                                                document-id="[[_selectedPrescriptionObject.document.id]]"
                                                language="[[language]]"
                                                preview="true"
                                                downloadable="true"
                                                fullwidth="true"
                                                force-no-assignation="true"
                                                force-no-document-header="true"
                                                additional-css-class="tripTyque"
                                            ></dynamic-doc>
                                        </template>
                                    </div>
                                </template>



                                <template is="dom-if" if="[[!_selectedPrescriptionBoolean]]">
                                    <h4 class="textaligncenter uppercase"><iron-icon icon="vaadin:pills" class="mr8 darkBlue"></iron-icon> [[localize('choosePrescriptionForTriptyque','Please choose a prescription to link to your triptyque',language)]]:</h4>
                                    <template is="dom-repeat" items="[[_pdfPrescriptionsList]]" as="singlePdfPrescription">

                                        <div class="singlePdfPrescription" data-service-id$="[[singlePdfPrescription.service.id]]" data-form-id$="[[singlePdfPrescription.formId]]" data-document-id$="[[singlePdfPrescription.document.id]]">
                                            <div class="header p10">
                                                <span class="date">[[singlePdfPrescription.dateAndTimeHr]]</span>
                                                <paper-button class="p0 m0 fr" on-tap="_linkPdfPrescription" data-contact-id$="[[singlePdfPrescription.contact.id]]" data-service-id$="[[singlePdfPrescription.service.id]]" data-form-id$="[[singlePdfPrescription.formId]]" data-document-id$="[[singlePdfPrescription.document.id]]"><iron-icon icon="icons:link" id$="link-[[singlePdfPrescription.service.id]]"></iron-icon></paper-button><paper-tooltip for$="link-[[singlePdfPrescription.service.id]]">[[localize('linkPdf','Link PDF',language)]]</paper-tooltip>
                                                <paper-button class="p0 m0 fr mr10" on-tap="_toggleCollapsePdfPreview" data-contact-id$="[[singlePdfPrescription.contact.id]]" data-service-id$="[[singlePdfPrescription.service.id]]" data-form-id$="[[singlePdfPrescription.formId]]" data-document-id$="[[singlePdfPrescription.document.id]]"><iron-icon icon="icons:visibility" id$="view-[[singlePdfPrescription.service.id]]"></iron-icon></paper-button><paper-tooltip for$="view-[[singlePdfPrescription.service.id]]">[[localize('ehb.view','View',language)]]</paper-tooltip>
                                            </div>
                                            <div class="body p5 fspoint9em"><iron-icon icon="image:picture-as-pdf" class="mr5 darkRed"></iron-icon> [[singlePdfPrescription.serviceTitle]]</div>

                                            <template is="dom-if" if="[[_isEqual(_currentPdfPreviewDocumentId, singlePdfPrescription.document.id)]]">
                                                <dynamic-doc
                                                    id="pdf-preview-[[singlePdfPrescription.document.id]]"
                                                    api="[[api]]"
                                                    i18n="[[i18n]]"
                                                    user="[[user]]"
                                                    document-id="[[singlePdfPrescription.document.id]]"
                                                    title="[[singlePdfPrescription.serviceTitle]]"
                                                    language="[[language]]"
                                                    preview="true"
                                                    downloadable="true"
                                                    fullwidth="true"
                                                    force-no-assignation="true"
                                                    force-no-document-header="true"
                                                    additional-css-class="tripTyque"
                                                ></dynamic-doc>
                                            </template>

                                        </div>

                                    </template>
                                </template>



                            </div>
                        </div>
                        <div class="panelNavigatorAnchor bl0"><paper-button on-tap="_toggleCollapsePdfPanel"><iron-icon icon="hardware:keyboard-arrow-left"></iron-icon> [[localize('prescription','Prescription',language)]] PDF</paper-button></div>



                        <paper-tabs selected="{{_triptyqueDetailActiveTab}}" attr-for-selected="name" class="p0">
                            <paper-tab class="dialogTab" name="prescriptionForm"><iron-icon icon="vaadin:pills" class="mr8 darkBlue"></iron-icon>[[localize('prescription','Prescription',language)]]</paper-tab>
                            <paper-tab class="dialogTab" name="summary"><iron-icon icon="icons:list" class="mr8 darkBlue"></iron-icon> [[localize('summary','Summary',language)]]</paper-tab>
                            <paper-tab class="dialogTab" name="procedures"><iron-icon icon="vaadin:tools" class="mr8 darkBlue"></iron-icon> [[localize('proc(s)','Procedure(s)',language)]] <span class="batchNumber greenBg ml10">[[_totalExistingProceduresForCurrentPlanOfAction]]</span></paper-tab>
                        </paper-tabs>



                        <div class="dialogTabContent p10">



                            <template is="dom-if" if="[[_isEqual(_triptyqueDetailActiveTab,'prescriptionForm')]]">

                                <template is="dom-if" if="[[!_selectedPrescriptionBoolean]]"><iron-icon icon="warning" class="mr8 darkRed"></iron-icon> [[localize('pleaseLinkPrescriptionToTriptyqueFirst','Please link a prescription to your triptyque first',language)]].</template>

                                <template is="dom-if" if="[[_selectedPrescriptionBoolean]]">
                                    <dynamically-loaded-form
                                        id="dynamicallyLoadedFormTripTyque"
                                        api="[[api]]"
                                        user="[[user]]"
                                        i18n="[[i18n]]"
                                        language="[[language]]"
                                        resources="[[resources]]"
                                        patient="[[patient]]"
                                        form-id="[[_selectedPrescriptionObject.formId]]"
                                        contact="[[_selectedPrescriptionObject.contact]]"
                                        contacts="[[_selectedPrescriptionObject.contacts]]"
                                        current-contact="[[_selectedPrescriptionObject.contact]]"
                                        force-no-print="true"
                                        force-no-title="true"
                                        additional-css-class="tripTyque"

                                        services-map="[[_selectedPrescriptionObject.servicesMap]]"

                                        on-data-change="_prescriptionFormDataGotChanged"
                                        on-edit-form="edit"

                                     ></dynamically-loaded-form>

                                    </template>

                            </template>



                            <template is="dom-if" if="[[_isEqual(_triptyqueDetailActiveTab,'summary')]]">

                                <template is="dom-if" if="[[!_selectedPrescriptionBoolean]]"><iron-icon icon="warning" class="mr8 darkRed"></iron-icon> [[localize('pleaseLinkPrescriptionToTriptyqueFirst','Please link a prescription to your triptyque first',language)]].</template>

                                <template is="dom-if" if="[[_selectedPrescriptionBoolean]]">
                                    Plan d'action
                                </template>

                            </template>



                            <template is="dom-if" if="[[_isEqual(_triptyqueDetailActiveTab,'procedures')]]">

                                <template is="dom-if" if="[[!_selectedPrescriptionBoolean]]"><iron-icon icon="warning" class="mr8 darkRed"></iron-icon> [[localize('pleaseLinkPrescriptionToTriptyqueFirst','Please link a prescription to your triptyque first',language)]].</template>

                                <template is="dom-if" if="[[_selectedPrescriptionBoolean]]">
                                    Procédures
                                </template>

                            </template>



                        </div>



                        <div class="buttons">
                            <paper-button on-tap="_closeTriptyqueDialog" class="modal-button modal-button--cancel"><iron-icon icon="icons:close" class=""></iron-icon>[[localize('clo','Close',language)]]</paper-button>
                            <paper-button on-tap="_XXXXXX" class="modal-button modal-button--save"><iron-icon icon="icons:save" class=""></iron-icon>[[localize('save','Save',language)]]</paper-button>
                            <paper-button on-tap="_XXXXXX" class="modal-button modal-button--cancel"><iron-icon icon="icons:save" class="mr0"></iron-icon>Icone ... verticaux + ouvrir sub-menu d'actions</paper-button>
                        </div>

                    </div>

                </div>


            </template>



        </paper-dialog>





    </template>





    <script>

        import _ from 'lodash/lodash';
        import moment from 'moment/src/moment';

        class HtPatTriptyqueDialog extends Polymer.TkLocalizerMixin(Polymer.Element) {

            static get is() {
                return 'ht-pat-triptyque-dialog';
            }

            static get properties() {
                return {
                    api: {
                        type: Object,
                        noReset: true,
                        value: () => {}
                    },
                    user: {
                        type: Object,
                        noReset: true,
                        value: () => {}
                    },
                    i18n: {
                        type: Object,
                        noReset: true,
                        value: () => {}
                    },
                    resources: {
                        type: Object,
                        noReset: true,
                        value: () => {}
                    },
                    language: {
                        type: String,
                        noReset: true,
                        value: "fr"
                    },
                    _isLoading: {
                        type: Boolean,
                        value: true,
                        noReset: true
                    },
                    _loadingMessages: {
                        type: Array,
                        value: () => []
                    },
                    _dialogParameters: {
                        type: Object,
                        value: () => {
                            return {
                                actions: {
                                    listing: true,
                                    detail: false
                                },
                                triptyqueType: "physiotherapist",
                                configByType: {
                                    physiotherapist: {
                                        pdfDocumentsLabelKey: "requestForKineCare_header1",
                                        formTemplateGuid: "AEFED10A-9A72-4B40-981B-1D79ADB05516"
                                    },
                                    persnurse: {
                                        pdfDocumentsLabelKey: "requestForNurseCare_header1",
                                        formTemplateGuid: "64DAB551-B007-4B5C-BD64-F886301F5326"
                                    }
                                }
                            }
                        }
                    },
                    patient: {
                        type: Object,
                        noReset: true,
                        value: () => {}
                    },
                    _vaadinGridPlanOfActionDataToShow: {
                        type: Array,
                        value: () => []
                    },
                    _vaadinGridPlanOfActionActiveItem: {
                        type: Object,
                        value: () => {}
                    },
                    _vaadinGridPlanOfActionMaxItemsPerPage: {
                        type: Number,
                        value: 100
                    },
                    _triptyqueDetailActiveTab: {
                        type: String,
                        value: "prescriptionForm"
                    },
                    _totalExistingProceduresForCurrentPlanOfAction: {
                        type: Number,
                        value: 0
                    },
                    _pdfPrescriptionsList: {
                        type: Array,
                        value: () => []
                    },
                    _currentPdfPreviewDocumentId: {
                        type: String,
                        value: ""
                    },
                    _selectedPrescriptionObject: {
                        type: Object,
                        value: () => {}
                    },
                    _selectedPrescriptionBoolean: {
                        type: Boolean,
                        value: false
                    }
                };
            }

            static get observers() {
                return [
                    '_loadingStatusChanged(_isLoading)',
                    '_vaadinGridPlanOfActionActiveItemChanged(_vaadinGridPlanOfActionActiveItem)',
                    '_selectedDocumentChanged(_selectedPrescriptionObject)',
                ]
            }

            constructor() {
                super();
            }

            ready() {
                super.ready();
            }

            _loadingStatusChanged() {
                if(!this._isLoading) this._resetLoadingMessage();
            }

            _resetLoadingMessage() {
                this._loadingMessages = [];
            }

            _setLoadingMessage( messageData ) {
                setTimeout(()=> {
                    if (!!_.get(messageData,"updateLastMessage",false)) this._loadingMessages.pop();
                    this._loadingMessages.push(messageData);
                    const loadingContentTarget = this.shadowRoot.querySelectorAll('#loadingContent')[0];
                    if (loadingContentTarget) { loadingContentTarget.innerHTML = ''; _.each(this._loadingMessages, (v) => { loadingContentTarget.innerHTML += "<p><iron-icon icon='" + v.icon + "' class='" + (v.done ? "loadingIcon done" : "loadingIcon") + "'></iron-icon>" + v.message + "</p>"; }); }
                },100)
            }

            _resetComponentProperties() {

                const promResolve = Promise.resolve();

                return promResolve
                    .then(() => {
                        const componentProperties = HtPatTriptyqueDialog.properties
                        Object.keys(componentProperties).forEach(k => { if (!_.get(componentProperties[k],"noReset", false)) { this.set(k, (typeof componentProperties[k].value === 'function' ? componentProperties[k].value() : (componentProperties[k].value || null))) }})
                        return promResolve
                    })

            }

            _closeTriptyqueDialog() {

                const promResolve = Promise.resolve();

                return promResolve
                    .then(() => this._resetComponentProperties())
                    .then(() => {
                        this.$["triptyqueDialog"].close()
                        this.dispatchEvent(new CustomEvent("triptyque-dialog-closed", {composed: true, bubbles: true, detail: {}}))
                        return promResolve
                    })

            }

            _changeDialogAction(action) {

                const promResolve = Promise.resolve();

                return promResolve
                    .then(() => _.map(_.keys(_.get(this,"_dialogParameters.actions",[])), k => this.set("_dialogParameters.actions."+k, false)))
                    .then(() => this.set("_dialogParameters.actions."+action, true))
                    .then(() => setTimeout(()=>{
                        _.map(this.shadowRoot.querySelectorAll('.panelNavigator'), i => i && i.classList && i.classList.remove('visible'))
                        return action === "detail" ?
                            this.shadowRoot.querySelector('#panelNavigator_2').classList.add('visible') :
                            this.shadowRoot.querySelector('#panelNavigator_1').classList.add('visible')
                    },1))
                    .then(() => promResolve )

            }

            _getGridSelectedItems() {
                return _.get(this.shadowRoot.querySelector('#vaadinGridPlanOfAction'), "selectedItems", []);
            }

            _resetGridSelectedItems() {
                const vaadinGrid = this.shadowRoot.querySelector('#vaadinGridPlanOfAction');
                return vaadinGrid ? vaadinGrid.selectedItems = [] : false
            }

            _clearGridCache() {
                const vaadinGrid = this.shadowRoot.querySelector('#vaadinGridPlanOfAction');
                vaadinGrid && vaadinGrid.clearCache()
            }

            _isEqual(a, b) {
                return !!(a===b)
            }

            _msTstampToDDMMYYYY(msTstamp) {
                return parseInt(msTstamp) ? this.api.moment(parseInt(msTstamp)).format('DD/MM/YYYY') : ""
            }

            _closePlanOfAction(e) {

                return this.set("_vaadinGridPlanOfActionActiveItem", {})

            }

            _formatTranslateGender(gender){
                return gender === "female" ?
                    this.localize("abrv_female","Miss",this.language) :
                    this.localize("abrv_male","Mr.",this.language)
            }

            _ucFirst(inputValue){
                return _.map(_.trim(inputValue).split(" "),i=>_.upperFirst(_.trim(i).toLowerCase())).join(" ")
            }

            _formatDateOfBirth(inputValue){
                return inputValue ? this.api.moment(inputValue).format('DD/MM/YYYY') : ''
            }

            _dobToAge(inputValue) {
                return inputValue ? this.api.getCurrentAgeFromBirthDate(inputValue,( e , s ) => this.localize(e, s, this.language)) : ''
            }

            _toggleCollapsePdfPanel(e) {

                const pdfPanel = this.shadowRoot.querySelector('#pdfPanel')
                const targetButton = !!_.size(_.get(e,"target","")) && _.get(e,"target.nodeName","") === "PAPER-BUTTON" ? e.target : _.find( e.path, p => _.get(p,"nodeName","") === "PAPER-BUTTON")

                pdfPanel && pdfPanel.classList && pdfPanel.classList.toggle("collapsed")
                targetButton && targetButton.firstElementChild && targetButton.firstElementChild.classList && targetButton.firstElementChild.classList.toggle("collapsedIcon")

            }

            _toggleCollapsePdfPreview(e) {

                const promResolve = Promise.resolve();
                const targetButton = !!_.size(_.get(e,"target","")) && _.get(e,"target.nodeName","") === "PAPER-BUTTON" ? e.target : _.find( e.path, p => _.get(p,"nodeName","") === "PAPER-BUTTON")
                const documentId = _.trim(_.get(targetButton,"dataset.documentId"))

                return !_.trim(documentId) ? promResolve : promResolve
                    .then(()=> _.trim(_.get(this,"_currentPdfPreviewDocumentId","")) === documentId ?
                        this.set("_currentPdfPreviewDocumentId", "") :
                        this.set("_currentPdfPreviewDocumentId", documentId)
                    )
                    .then(()=>{
                        const targetPdfPreviewPdfElement = this.shadowRoot.querySelector("#pdf-preview-" + documentId) && this.shadowRoot.querySelector("#pdf-preview-" + documentId).shadowRoot.querySelector("pdf-element")
                        return typeof _.get(targetPdfPreviewPdfElement,"onWidthChange","") === "function" ? targetPdfPreviewPdfElement.onWidthChange() : false
                    })

            }

            _selectedDocumentChanged(_selectedPrescriptionObject) {
                this.set("_selectedPrescriptionBoolean", !!_.size(_selectedPrescriptionObject) )
            }

            _unlinkPdfPrescription(e) {
                this.set("_selectedPrescriptionObject", {})
            }

            _getServicesMap(singleContact) {
                return singleContact.reduce((map, ctc) => {
                    const svcMap = ctc.subContacts.reduce((svcMap, subContact) => { subContact.services.reduce((svcMap, svcLink) => { (svcMap[svcLink.serviceId] || (svcMap[svcLink.serviceId] = [])).push(subContact); return svcMap; }, svcMap); return svcMap; }, {});
                    ctc.services.reduce((map, svc) => { (map[svc.label] || (map[svc.label] = [])).push({ svc: svc, scs: svcMap[svc.id] || [], ctc: ctc }); return map; }, map);
                    Object.values(map).forEach(arr => arr.sort((a, b) => b.svc.modified - a.svc.modified));
                    return map;
                }, {})
            }

            _linkPdfPrescription(e) {

                this.set("_isLoading", true);

                const promResolve = Promise.resolve();
                const targetButton = !!_.size(_.get(e,"target","")) && _.get(e,"target.nodeName","") === "PAPER-BUTTON" ? e.target : _.find( e.path, p => _.get(p,"nodeName","") === "PAPER-BUTTON")
                const documentId = _.trim(_.get(targetButton,"dataset.documentId"))
                const documentContactId = _.trim(_.get(targetButton,"dataset.contactId"))
                const documentServiceId = _.trim(_.get(targetButton,"dataset.serviceId"))
                const documentFormId = _.trim(_.get(targetButton,"dataset.formId"))
                const formTemplateGuid = _.trim(_.get(this,"_dialogParameters.configByType." + _.get(this,"_dialogParameters.triptyqueType","") + ".formTemplateGuid",""))
                const selectedPrescriptionObject = _.find(this._pdfPrescriptionsList, i=> i.service.id === documentServiceId && i.document.id === documentId)
                const documentContactObject = _.get(selectedPrescriptionObject,"contact",{})

                return promResolve
                    // .then(() => this.api.patient().getPatientWithUser(this.user, _.trim(_.get(this,"patient.id",""))))
                    // .then(patientObject => this.api.contact().newInstance(this.user, patientObject, {
                    //         groupId: documentId,
                    //         created: +new Date,
                    //         modified: +new Date,
                    //         author: _.trim(_.get(this,"user.id","")),
                    //         responsible: _.trim(_.get(this,"user.healthcarePartyId","")),
                    //         openingDate: moment().format('YYYYMMDDHHmmss'),
                    //         closingDate: moment().format('YYYYMMDDHHmmss'),
                    //         encounterType: { type: "CD-TRANSACTION", version: "1", code: documentType },
                    //         descr: _.trim(documentTypeLabel) + ": " + _.trim(_.get(documentToAssign,"docInfo[0].labo","")),
                    //         tags: [{type: 'CD-TRANSACTION', code: documentType}],
                    //         subContacts: []
                    //     }).then(contactInstance => [contactInstance,patientObject])
                    // )
                    // .then(([contactInstance,patientObject]) => {
                    //
                    //     if(isLabResult) {
                    //         contactInstance.services.push({
                    //             id: this.api.crypto().randomUuid(),
                    //             label: documentType,
                    //             valueDate: parseInt(moment().format('YYYYMMDDHHmmss')),
                    //             content: _.fromPairs([[this.language, {stringValue: _.trim(_.get(documentToAssign,"docInfo[0].labo",""))}]]),
                    //             tags: [{type: 'CD-TRANSACTION', code: documentType}]
                    //         })
                    //     } else {
                    //         const svc = this.api.contact().service().newInstance( this.user, { tags: [{type: 'CD-TRANSACTION', code: documentType}], content: _.fromPairs([[this.language, {documentId: documentId, stringValue: _.trim(_.get(documentToAssign,"name",""))}]]), label: (_.trim(documentTypeLabel) ? _.trim(documentTypeLabel) : "Annexe") + ": " + _.trim(_.get(documentToAssign,"name","")) })
                    //         contactInstance.services = [svc]
                    //         contactInstance.subContacts.push({status: 64, services: [{serviceId: svc.id}]})
                    //     }
                    //
                    //     return this.api.contact().createContactWithUser(this.user, contactInstance)
                    //         .then(createdContact => [createdContact,patientObject])
                    //
                    // })
                    // .then(([createdContact,patientObject]) => !isLabResult ? createdContact :
                    //     this.api.form().newInstance(this.user, patientObject, {contactId: _.trim(_.get(createdContact,"id","")), descr: "Lab result " + +new Date})
                    //         .then(formInstance => this.api.form().createForm(formInstance))
                    //         .then(createdForm







                    .then(() => this.api.hcparty().getCurrentHealthcareParty()
                        .then(currentHcp => Promise.all([
                            this.api.form().getFormTemplatesByGuid( formTemplateGuid, "deptgeneralpractice" ),
                            this.api.form().getFormTemplatesByGuid( formTemplateGuid, _.trim(_.get(currentHcp,"specialityCodes[0].code", "deptgeneralpractice")).replace(/persphysician/, 'deptgeneralpractice'))
                        ]).then(promResults => _.chain(promResults).flatten().filter(x=>!_.get(x,"disabled",false)).uniqBy("guid").compact().head().value()))
                        .then(formTemplate => this.api.form().newInstance(this.user, this.patient, { contactId: documentContactId, formTemplateId: _.trim(_.get(formTemplate,"id","")), descr: _.trim(_.get(formTemplate,"name","")) }))
                        .then(formInstance => this.api.form().createForm(formInstance).then(createdForm => _.trim(_.get(createdForm,"id",""))))
                    )
                    .then(createdOrExistingFormId => {

                        // FABIEN: faire un nouveau contact à l'instant T lors liaison avec triptyque SSI form existe pas encore (celui dans lequel je travaille, PAS le form éventuellement lié à mon PDF)
                        // FABIEN: ouvrir et fermer directement ce contact
                        // FABIEN: Sinon je ne passe pas par ici (SSI form DU TRIPTYQUE existe) -> pas confondre avec le form éventuellement lié (par le praticien général - dans le cas d'une MM) à la prescription. Dans 99.99% des cas -> ne sera pas le cas

                        console.log("createdOrExistingFormId",createdOrExistingFormId);
                        selectedPrescriptionObject.formId = _.trim(createdOrExistingFormId)
                        selectedPrescriptionObject.contact.subContacts.push({ formId: _.trim(createdOrExistingFormId), services: [] })
                        selectedPrescriptionObject.contacts = [documentContactObject]
                        selectedPrescriptionObject.servicesMap = this._getServicesMap([documentContactObject])

                        this.set("_currentPdfPreviewDocumentId", "")
                        this.set("_selectedPrescriptionObject", selectedPrescriptionObject)

                    })
                    .finally(() => {

                        console.log("documentContactId", documentContactId);
                        console.log("documentServiceId", documentServiceId);
                        console.log("documentFormId", documentFormId);

                        console.log("this._pdfPrescriptionsList", this._pdfPrescriptionsList);
                        console.log("selectedPrescriptionObject", selectedPrescriptionObject);

                        console.log(this.patient);

                        this.set("_isLoading", false);

                    })


                // let helement = {
                //     descr: healthElement.descr,
                //     openingDate: healthElement.openingDate || +new Date(),
                //     closingDate: healthElement.closingDate,
                //     status: healthElement.status || 0,
                //     plansOfAction: (healthElement.plansOfAction || []).map(poa => _.extend(poa, { id: this.api.crypto().randomUuid(), openingDate: parseInt(moment().format('YYYYMMDDHHmmss')) })),
                //     tags: (healthElement.tags || []).map(c => this.api.code().normalize(c)),
                //     codes: (healthElement.codes || []).map(c => this.api.code().normalize(c)),
                //     idService: healthElement.idService
                // }

                // let helement = {
                //     descr: "",
                //     openingDate: +new Date(),
                //     closingDate: "",
                //     status: 0,
                //     plansOfAction: (healthElement.plansOfAction || []).map(poa => _.extend(poa, { id: this.api.crypto().randomUuid(), openingDate: parseInt(moment().format('YYYYMMDDHHmmss')) })),
                //     tags: (healthElement.tags || []).map(c => this.api.code().normalize(c)),
                //     codes: (healthElement.codes || []).map(c => this.api.code().normalize(c)),
                //     idService: serviceId
                // }

                // this.api.helement()
                //     .newInstance(
                //         this.user,
                //         this.patient,
                //         this._normalizedHealthElement(healthElement)
                //     )
                //         .then(he => this.api.helement().createHealthElement(he))
                //         .then(he => {
                //             console.log("he", he)
                //         })

                // PlanOfActionDto {
                //     id?: string;
                //     name?: string;
                //     descr?: string;
                //     valueDate?: number;
                //     openingDate?: number;
                //     closingDate?: number;
                //     idOpeningContact?: string;
                //     idClosingContact?: string;
                //     author?: string;
                //     responsible?: string;
                //     created?: number;
                //     modified?: number;
                //     endOfLife?: number;
                //     codes?: Array<models.CodeDto>;
                //     tags?: Array<models.CodeDto>;
                // }

                // HealthElementDto {
                //     id?: string;
                //     created?: number;
                //     modified?: number;
                //     endOfLife?: number;
                //     author?: string;
                //     responsible?: string;
                //     medicalLocationId?: string;
                //     codes?: Array<models.CodeDto>;
                //     tags?: Array<models.CodeDto>;
                //     healthElementId?: string;
                //     descr?: string;
                //     note?: string;
                //     relevant?: boolean;
                //     valueDate?: number;
                //     openingDate?: number;
                //     closingDate?: number;
                //     idOpeningContact?: string;
                //     idClosingContact?: string;
                //     status?: number;
                //     idService?: string;
                //     plansOfAction?: Array<models.PlanOfActionDto>;
                // }

            }








            _prescriptionFormDataGotChanged(e) {

                console.log("----- _prescriptionFormDataGotChanged -----", e);

            }

            _getPdfPrescriptionsListOrAlreadyLinkedPdfPrescription(inputConfig={}) {

                // Fabien: inputConfig ==> aller rechercher contact / services / pdf / form... si déjà lié

                const pdfDocumentsLabelKey = _.get(this,"_dialogParameters.configByType." + _.get(this,"_dialogParameters.triptyqueType","") + ".pdfDocumentsLabelKey","")
                const pdfDocumentsServiceStringValue = this.localize(pdfDocumentsLabelKey,"Prescription de kinésithérapie", this.language)

                return this.api.contact().findBy( this.user.healthcarePartyId, this.patient )
                    .then(patientContacts => _.compact(_.flatten(_.map(patientContacts, singleContact => _.map(singleContact.services, singleService => !_.trim(_.get(singleService,"content." + this.language + ".documentId")) ? false : {
                        contact: singleContact,
                        service: singleService,
                        serviceTitle: _.trim(_.get(singleService,"content." + this.language + ".stringValue")),
                        formId: _.trim(_.get(singleService,"formId")),
                        date: parseInt(_.get(singleService,"valueDate")),
                        dateAndTimeHr: moment(parseInt(_.trim(_.get(singleService,"valueDate")).substring(0,8)),"YYYYMMDD").format('DD/MM/YYYY') + " - " + _.trim(_.get(singleService,"valueDate")).substring(8,10) + ":" + _.trim(_.get(singleService,"valueDate")).substring(10,12),
                        documentId: _.trim(_.get(singleService,"content." + this.language + ".documentId"))
                    })))))
                    .then(foundServicesWithPrescription => !_.size(foundServicesWithPrescription) ? false : this.api.document().getDocuments({ids:_.map(foundServicesWithPrescription,s=>s.documentId)}).then(foundDocuments=>[foundServicesWithPrescription,foundDocuments]))
                    .then(([foundServicesWithPrescription,foundDocuments]) => _.compact(_.map(foundServicesWithPrescription, fswp => {
                        const serviceDocument = _.find(foundDocuments, {id: _.trim(_.get(fswp, "documentId"))})
                        const documentExtension = _.trim(_.last(_.trim(_.get(serviceDocument,"name","")).split("."))).toLowerCase()
                        return (
                            (
                                fswp.serviceTitle !== pdfDocumentsServiceStringValue &&
                                _.trim(_.get(serviceDocument, "documentType", "")).toLowerCase() !== "prescription"
                            ) ||
                            ['jpg','jpeg','pdf','png','tif','tiff'].indexOf(documentExtension) === -1 ||
                            !_.trim(_.get(serviceDocument,"id","")) ||
                            !_.trim(_.get(serviceDocument,"attachmentId","")) ||
                            !_.trim(_.get(serviceDocument,"secretForeignKeys",""))
                        ) ? false : _.merge({}, _.omit(fswp, ['documentId']), {document: serviceDocument})
                    })))
                    .then(servicesAndDocuments => Promise.all(servicesAndDocuments.map(sad => this.api.crypto().extractKeysFromDelegationsForHcpHierarchy(_.get(this, "user.healthcarePartyId", null), _.trim(_.get(sad.document, "id", "")), _.size(_.get(sad.document, "encryptionKeys", [])) ? _.get(sad.document, "encryptionKeys", []) : _.get(sad.document, "delegations", []))
                            .then(({extractedKeys: enckeys}) => !!_.trim(_.get(sad.document,"id","")) && _.trim(_.get(sad.document,"attachmentId","")) ? this.api.document().getAttachment(_.trim(_.get(sad.document,"id","")), _.trim(_.get(sad.document,"attachmentId","")), enckeys.join(',')).then(decryptedContent=>(_.merge(sad, {document:{decryptedContent:decryptedContent}}))).catch(e=>{console.log("ERROR with getAttachment: ",e); }) : sad)
                        )).then(servicesAndDocuments => servicesAndDocuments)
                    )
                    .then(servicesAndDocuments => _
                        .chain(servicesAndDocuments)
                        .filter(i => !!_.trim(_.get(i,"document.id")) && !!parseInt(_.get(i,"document.decryptedContent.byteLength")) )
                        .orderBy(['date'], ['desc'])
                        .value()
                    )

            }

            open(dialogParameters) {

                const promResolve = Promise.resolve();
                this._setLoadingMessage({ message: this.localize('ongoingProcess',this.language), icon:"arrow-forward"});

                return promResolve
                    .then(() => this._resetComponentProperties())
                    .then(() => _.merge(this, dialogParameters) && this.$["triptyqueDialog"].open() && promResolve)
                    .then(() => {

                        this._clearGridCache()
                        this._resetGridSelectedItems()
                        this.set("_vaadinGridPlanOfActionDataToShow", [
                            {
                                id: "123-456-789",
                                openingDate: "29/06/2019",
                                heDescr: "Health element description",
                                prescriptionExists: "Juste dire oui / non",
                                label: "Libellé du plan (besoin dates ?)",
                                prescriber: "Docteur Frankenstein",
                                responsibleHr: "Docteur Maboule",
                                contactsCount: "2",
                                numberOfCares: "7",
                                statusHr: "En cours"
                            },
                            {
                                id: "987-654-321",
                                openingDate: "25/06/2019",
                                heDescr: "Health element description 2",
                                prescriptionExists: "Juste dire oui / non 2",
                                label: "Libellé du plan 2 (besoin dates ?)",
                                prescriber: "Docteur Frankenstein 2",
                                responsibleHr: "Docteur Jamoule",
                                contactsCount: "0",
                                numberOfCares: "8",
                                statusHr: "En attente"
                            }
                        ])

                    })
                    .finally(()=>{

                        this.set("_isLoading", false);
                        this._changeDialogAction("listing")

                        console.log(this.user);
                        console.log(this.patient);
                        console.log(this._dialogParameters);

                    })

            }

            _addPlanOfAction() {

                this.set("_isLoading", true);
                return this._changeDialogAction("detail")
                    .then(()=>{
                        console.log("_addPlanOfAction");
                        console.log("Patient", this.patient)
                    })
                    .finally(()=>this.set("_isLoading", false))

            }

            _vaadinGridPlanOfActionActiveItemChanged(activeItem) {

                this.set("_isLoading", true);

                return !_.trim(_.get(activeItem,"id","")) ?
                    this._changeDialogAction("listing").finally(()=>this.set("_isLoading", false)) :
                    this._changeDialogAction("detail")
                        .then(()=> {

                            // Fabien : Soit pdf déjà lié -> get juste celui-là
                            // Fabien : Soit get la liste des PDF qui existent déjà
                            return this._getPdfPrescriptionsListOrAlreadyLinkedPdfPrescription()

                        })
                        .then(pdfPrescriptions => {

                            this.set("_pdfPrescriptionsList", !!_.size(pdfPrescriptions) ? pdfPrescriptions : [])

                            console.log("Patient", this.patient)
                            console.log("GLOBAL active item", this._vaadinGridPlanOfActionActiveItem)

                        })
                        .finally(()=>this.set("_isLoading", false))

            }





















        }

        customElements.define(HtPatTriptyqueDialog.is, HtPatTriptyqueDialog);

    </script>



</dom-module>
